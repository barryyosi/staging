{
  "version": 3,
  "sources": ["../src/extension.ts"],
  "sourcesContent": ["import * as vscode from 'vscode';\nimport * as cp from 'child_process';\nimport * as path from 'path';\nimport * as http from 'http';\n\nlet serverProcess: cp.ChildProcess | undefined;\nlet serverPort: number | undefined;\nlet panel: vscode.WebviewPanel | undefined;\nlet outputChannel: vscode.OutputChannel;\n\nexport function activate(context: vscode.ExtensionContext) {\n  outputChannel = vscode.window.createOutputChannel('Staging Server');\n\n  context.subscriptions.push(\n    vscode.commands.registerCommand('staging.openReview', () =>\n      openStagingReview(context),\n    ),\n    vscode.commands.registerCommand('staging.restart', () =>\n      restartServer(context),\n    ),\n  );\n\n  // Sync theme when VS Code theme changes\n  context.subscriptions.push(\n    vscode.window.onDidChangeActiveColorTheme((theme) => {\n      if (panel) {\n        const isDark = theme.kind === vscode.ColorThemeKind.Dark ||\n          theme.kind === vscode.ColorThemeKind.HighContrast;\n        panel.webview.postMessage({\n          type: 'setTheme',\n          theme: isDark ? 'dark' : 'light',\n        });\n      }\n    }),\n  );\n}\n\nasync function openStagingReview(context: vscode.ExtensionContext) {\n  // If panel already exists, reveal it\n  if (panel) {\n    panel.reveal(vscode.ViewColumn.One);\n    return;\n  }\n\n  const workspaceRoot = getWorkspaceRoot();\n  if (!workspaceRoot) {\n    vscode.window.showErrorMessage(\n      'Staging: No workspace folder open.',\n    );\n    return;\n  }\n\n  // Start server if not already running\n  if (!serverProcess || serverPort === undefined) {\n    try {\n      await startServer(workspaceRoot, context);\n    } catch (err: any) {\n      vscode.window.showErrorMessage(\n        `Staging: Failed to start server \u2014 ${err.message}`,\n      );\n      return;\n    }\n  }\n\n  createWebviewPanel(context);\n}\n\nfunction getWorkspaceRoot(): string | undefined {\n  const folders = vscode.workspace.workspaceFolders;\n  return folders?.[0]?.uri.fsPath;\n}\n\nfunction findStagingCli(context: vscode.ExtensionContext): string {\n  // The extension lives in vscode-staging/ inside the staging repo.\n  // bin/staging.js is at ../bin/staging.js relative to the extension root.\n  return path.resolve(context.extensionPath, '..', 'bin', 'staging.js');\n}\n\nfunction startServer(\n  workspaceRoot: string,\n  context: vscode.ExtensionContext,\n): Promise<void> {\n  return new Promise((resolve, reject) => {\n    const config = vscode.workspace.getConfiguration('staging');\n    const port = config.get<number>('port', 0);\n    const cliPath = findStagingCli(context);\n\n    const args = [cliPath, workspaceRoot, '--no-open'];\n    if (port > 0) {\n      // The CLI uses config.port from its own config, but we pass port\n      // via env or let the server auto-assign. For now, auto-assign.\n    }\n\n    outputChannel.appendLine(`Starting: node ${args.join(' ')}`);\n\n    const proc = cp.spawn('node', args, {\n      cwd: workspaceRoot,\n      stdio: ['ignore', 'pipe', 'pipe'],\n      env: { ...process.env },\n    });\n\n    serverProcess = proc;\n    let resolved = false;\n\n    const timeout = setTimeout(() => {\n      if (!resolved) {\n        resolved = true;\n        reject(new Error('Server did not start within 10 seconds'));\n      }\n    }, 10_000);\n\n    proc.stdout!.on('data', (data: Buffer) => {\n      const text = data.toString();\n      outputChannel.appendLine(text.trimEnd());\n\n      if (!resolved) {\n        // Parse port from: \"Staging review at http://127.0.0.1:<port>\"\n        const match = text.match(\n          /Staging review at http:\\/\\/127\\.0\\.0\\.1:(\\d+)/,\n        );\n        if (match) {\n          serverPort = parseInt(match[1], 10);\n          resolved = true;\n          clearTimeout(timeout);\n          outputChannel.appendLine(`Server running on port ${serverPort}`);\n          resolve();\n        }\n      }\n    });\n\n    proc.stderr!.on('data', (data: Buffer) => {\n      outputChannel.appendLine(`[stderr] ${data.toString().trimEnd()}`);\n    });\n\n    proc.on('exit', (code) => {\n      outputChannel.appendLine(`Server exited with code ${code}`);\n      serverProcess = undefined;\n      serverPort = undefined;\n      if (!resolved) {\n        resolved = true;\n        clearTimeout(timeout);\n        reject(new Error(`Server exited with code ${code}`));\n      }\n    });\n\n    proc.on('error', (err) => {\n      outputChannel.appendLine(`Server error: ${err.message}`);\n      serverProcess = undefined;\n      serverPort = undefined;\n      if (!resolved) {\n        resolved = true;\n        clearTimeout(timeout);\n        reject(err);\n      }\n    });\n  });\n}\n\nfunction createWebviewPanel(context: vscode.ExtensionContext) {\n  const isDark =\n    vscode.window.activeColorTheme.kind === vscode.ColorThemeKind.Dark ||\n    vscode.window.activeColorTheme.kind === vscode.ColorThemeKind.HighContrast;\n  const theme = isDark ? 'dark' : 'light';\n\n  panel = vscode.window.createWebviewPanel(\n    'stagingReview',\n    'Staging Review',\n    vscode.ViewColumn.One,\n    {\n      enableScripts: true,\n      retainContextWhenHidden: true,\n    },\n  );\n\n  panel.webview.html = getWebviewHtml(serverPort!, theme);\n\n  panel.onDidDispose(() => {\n    panel = undefined;\n  }, null, context.subscriptions);\n}\n\nfunction getWebviewHtml(port: number, theme: string): string {\n  const src = `http://127.0.0.1:${port}?vscode=1&theme=${theme}`;\n\n  return /* html */ `<!DOCTYPE html>\n<html lang=\"en\" style=\"margin:0;padding:0;height:100%;overflow:hidden;\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta http-equiv=\"Content-Security-Policy\"\n    content=\"default-src 'none';\n             frame-src http://127.0.0.1:*;\n             script-src 'unsafe-inline';\n             style-src 'unsafe-inline';\">\n  <style>\n    html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }\n    iframe { display: block; border: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; }\n  </style>\n</head>\n<body>\n  <iframe id=\"staging-frame\" src=\"${src}\"></iframe>\n  <script>\n    const vscode = acquireVsCodeApi();\n    const iframe = document.getElementById('staging-frame');\n\n    // Forward theme messages from VS Code extension to the iframe\n    window.addEventListener('message', (e) => {\n      if (e.data && e.data.type === 'setTheme' && iframe.contentWindow) {\n        iframe.contentWindow.postMessage(e.data, '*');\n      }\n    });\n  </script>\n</body>\n</html>`;\n}\n\nasync function restartServer(context: vscode.ExtensionContext) {\n  await stopServer();\n\n  const workspaceRoot = getWorkspaceRoot();\n  if (!workspaceRoot) {\n    vscode.window.showErrorMessage('Staging: No workspace folder open.');\n    return;\n  }\n\n  try {\n    await startServer(workspaceRoot, context);\n    // Reload webview if open\n    if (panel) {\n      const isDark =\n        vscode.window.activeColorTheme.kind === vscode.ColorThemeKind.Dark ||\n        vscode.window.activeColorTheme.kind ===\n          vscode.ColorThemeKind.HighContrast;\n      panel.webview.html = getWebviewHtml(\n        serverPort!,\n        isDark ? 'dark' : 'light',\n      );\n    }\n    vscode.window.showInformationMessage('Staging: Server restarted.');\n  } catch (err: any) {\n    vscode.window.showErrorMessage(\n      `Staging: Failed to restart server \u2014 ${err.message}`,\n    );\n  }\n}\n\nasync function stopServer(): Promise<void> {\n  if (serverProcess && serverPort) {\n    // Try graceful shutdown via API first\n    try {\n      await httpPost(`http://127.0.0.1:${serverPort}/api/shutdown`);\n    } catch {\n      // Ignore \u2014 we'll kill the process below\n    }\n  }\n\n  if (serverProcess) {\n    serverProcess.kill('SIGTERM');\n    serverProcess = undefined;\n  }\n  serverPort = undefined;\n}\n\nfunction httpPost(url: string): Promise<void> {\n  return new Promise((resolve, reject) => {\n    const req = http.request(url, { method: 'POST' }, (res) => {\n      res.resume();\n      res.on('end', resolve);\n    });\n    req.on('error', reject);\n    req.setTimeout(2000, () => {\n      req.destroy();\n      resolve();\n    });\n    req.end();\n  });\n}\n\nexport function deactivate() {\n  if (panel) {\n    panel.dispose();\n    panel = undefined;\n  }\n\n  if (serverProcess) {\n    serverProcess.kill('SIGTERM');\n    serverProcess = undefined;\n  }\n  serverPort = undefined;\n}\n"],
  "mappings": "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",
  "names": ["resolve"]
}
